<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chat Privado Aurora</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <style>
    /* Tus estilos CSS anteriores se mantienen igual */
    /* ... */
  </style>
</head>

<body>

<div id="login">
  <h2>ðŸ”’ Acceso al Chat</h2>
  <input type="password" id="password" placeholder="ContraseÃ±a">
  <button onclick="checkPassword()">Entrar</button>
</div>

<div id="chat-container">
  <!-- La estructura del chat se mantiene igual -->
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCGIgoiTmjt3CsAGTx0_2sSVVVDUrAJm0c",
    authDomain: "chataurora-cb895.firebaseapp.com",
    databaseURL: "https://chataurora-cb895-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "chataurora-cb895",
    storageBucket: "chataurora-cb895.appspot.com",
    messagingSenderId: "908639294107",
    appId: "1:908639294107:web:2497ba35a0e3d84c882c3e"
  };

  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();
  const correctPassword = "aurora78";

  function checkPassword() {
    const pass = document.getElementById('password').value;
    if (pass === correctPassword) {
      login();
    } else {
      alert('ContraseÃ±a incorrecta.');
    }
  }

  function login() {
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat-container').style.display = 'flex';
    document.getElementById('input-container').style.display = 'flex';
    
    let username = localStorage.getItem('chat_username');
    if (!username) {
      username = prompt("Â¿CÃ³mo te llamas?");
      localStorage.setItem('chat_username', username);
    }
    
    registerUser(username);
    setupRealTimeUpdates();
  }

  function registerUser(username) {
    const userRef = db.ref('users/' + encodeURIComponent(username));
    userRef.set({
      name: username,
      lastActive: new Date().toISOString()
    });
    
    userRef.onDisconnect().remove();
  }

  function setupRealTimeUpdates() {
    // Usuarios en tiempo real
    db.ref('users').on('value', (snapshot) => {
      const users = snapshot.val() || {};
      const userList = document.getElementById('user-list');
      userList.innerHTML = Object.keys(users).map(u => 
        `<li>${decodeURIComponent(u)}</li>`
      ).join('');
    });

    // Mensajes en tiempo real
    db.ref('messages').on('child_added', (snapshot) => {
      const m = snapshot.val();
      const messagesDiv = document.getElementById('main-chat');
      
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `
        <b>${m.user}</b> [${m.time}]: 
        ${m.text || ''}
        ${m.file ? createMediaElement(m.file) : ''}
      `;
      
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }

  function createMediaElement(url) {
    if (url.startsWith('data:')) {
      return url.includes('image') ? 
        `<img src="${url}" onclick="this.remove()">` :
        `<audio controls src="${url}" onended="this.remove()"></audio>`;
    }
    
    // Archivo temporal de Firebase
    return url.includes('image') ?
      `<img src="${url}" onclick="this.remove(); deleteFile('${url}')">` :
      `<audio controls src="${url}" onended="this.remove(); deleteFile('${url}')"></audio>`;
  }

  async function sendMessage() {
    const input = document.getElementById('message-input');
    if (input.value.trim() === "") return;
    
    const message = {
      user: localStorage.getItem('chat_username'),
      text: input.value,
      time: new Date().toLocaleTimeString()
    };
    
    db.ref('messages').push(message);
    input.value = "";
  }

  async function sendFile() {
    const file = document.getElementById('file-input').files[0];
    if (!file) return;

    try {
      // Subir a Firebase Storage
      const storageRef = storage.ref(`temp_media/${Date.now()}_${file.name}`);
      await storageRef.put(file);
      const url = await storageRef.getDownloadURL();

      // Guardar referencia en la base de datos
      db.ref('messages').push({
        user: localStorage.getItem('chat_username'),
        file: url,
        time: new Date().toLocaleTimeString()
      });

      // Eliminar archivo despuÃ©s de 1 minuto
      setTimeout(async () => {
        await storageRef.delete();
      }, 60000);

    } catch (error) {
      console.error("Error subiendo archivo:", error);
    }
  }

  async function deleteFile(url) {
    try {
      const storageRef = storage.refFromURL(url);
      await storageRef.delete();
    } catch (error) {
      console.error("Error eliminando archivo:", error);
    }
  }

</script>

</body>
</html>
