<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Chat Privado</title>
  <style>
    :root { --primary: #4a90e2; --secondary: #e6f0fa; --bg: #f4faff; --text: #333; --white: #fff; }
    * { box-sizing: border-box; margin:0; padding:0; }
    html { font-size:16px; }
    body { font-family:sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; }
    #login { flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:20px; }
    #login input, #login button { width:100%; max-width:300px; margin:8px 0; padding:12px; border:1px solid var(--primary); border-radius:6px; font-size:1rem; }
    #login button { background:var(--primary); color:var(--white); cursor:pointer; }
    #chat-container { display:none; flex:1; flex-direction:column; position:relative; }
    #top-info { display:flex; justify-content:space-between; padding:4px 12px; background:var(--secondary); font-size:0.8rem; }
    #users, #log { background:var(--white); padding:4px 8px; border-radius:6px; overflow-y:auto; }
    #main-chat { flex:1; padding:10px; background:var(--white); overflow-y:auto; font-size:1rem; }
    .message { position:relative; margin-bottom:16px; padding:10px; background:var(--secondary); border-radius:8px; }
    .self { background:#c5e3fc; align-self:flex-end; }
    .time { position:absolute; bottom:4px; right:8px; font-size:0.7rem; color:#555; }
    #input-container { display:flex; align-items:center; padding:6px 8px; background:var(--secondary); position:absolute; bottom:0; width:100%; }
    #message-input { flex:1; padding:8px; border:1px solid var(--primary); border-radius:20px; outline:none; font-size:1rem; }
    .btn-circle { width:36px; height:36px; margin-left:6px; border:none; border-radius:50%; background:var(--primary); color:var(--white); cursor:pointer; display:flex; align-items:center; justify-content:center; }
    img.chat-img { max-width:100%; margin-top:6px; border-radius:6px; cursor:pointer; }
    audio { width:100%; margin-top:6px; }
    #imgModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; }
    #imgModal img { max-width:90%; max-height:90%; border-radius:8px; }
  </style>
</head>
<body>
  <div id="login">
    <h2>🔒 Acceso al Chat</h2>
    <input id="pwd" type="password" placeholder="Contraseña">
    <button id="login-btn">Entrar</button>
  </div>
  <div id="chat-container">
    <div id="top-info">
      <div id="users"><strong>👥 Activos:</strong><ul id="users-list"></ul></div>
      <div id="log"><strong>🕒 Log (48h):</strong><ul id="log-list"></ul></div>
    </div>
    <div id="main-chat"></div>
    <div id="input-container">
      <label class="btn-circle">📷<input id="file-input" type="file" accept="image/*"></label>
      <button id="emoji-btn" class="btn-circle">😃</button>
      <button id="record-btn" class="btn-circle">🎤</button>
      <input id="message-input" type="text" placeholder="Escribe tu mensaje…">
      <button id="send-btn" class="btn-circle">➤</button>
    </div>
  </div>
  <div id="imgModal" onclick="closeModal()"><img id="modalImg"></div>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@joeattardi/emoji-button@4.6.0/dist/index.min.js"></script>
  <script>
    // Configuración Firebase
    const firebaseConfig = { apiKey:"AIzaSy...", authDomain:"chataurora...", databaseURL:"https://chataurora...app", projectId:"chataurora-cb895", storageBucket:"chataurora-cb895.appspot.com", messagingSenderId:"908639294107", appId:"1:908639294107:web:..." };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const storage = firebase.storage();
    let username = localStorage.getItem('chat_username'); let mediaRecorder, audioChunks=[];

    // DOM Elements
    const loginBtn = document.getElementById('login-btn');
    const fileInput = document.getElementById('file-input');
    const emojiBtn = document.getElementById('emoji-btn');
    const recordBtn = document.getElementById('record-btn');
    const sendBtn = document.getElementById('send-btn');
    const messageInput = document.getElementById('message-input');

    // Eventos
    loginBtn.addEventListener('click', checkPassword);
    fileInput.addEventListener('change', sendFile);
    sendBtn.addEventListener('click', sendMessage);
    emojiBtn.addEventListener('click', () => picker.togglePicker(emojiBtn));
    recordBtn.addEventListener('click', toggleRecording);
    messageInput.addEventListener('keyup', e=> e.key==='Enter' && sendMessage());

    // Emoji Picker
    const picker = new EmojiButton({ position: 'top-end' });
    picker.on('emoji', emoji=>{ messageInput.value+=emoji; messageInput.focus(); });

    function checkPassword() {
      const pwd=document.getElementById('pwd').value;
      if (pwd!=='aurora78') { alert('Contraseña incorrecta'); return; }
      document.getElementById('login').style.display='none';
      document.getElementById('chat-container').style.display='flex';
      if (!username) { username=prompt('¿Cómo te llamas?')||'Anónimo'; localStorage.setItem('chat_username',username); }
      startChat();
    }

    function startChat() {
      const meRef=db.ref('users/'+username);
      meRef.set(true); meRef.onDisconnect().remove();
      db.ref('messages').orderByChild('timestamp').once('value',snap=>{ snap.forEach(ch=>displayMessage(ch.key,ch.val())); scrollBottom(); });
      db.ref('messages').orderByChild('timestamp').startAt(Date.now()).on('child_added',ch=>{ displayMessage(ch.key,ch.val()); scrollBottom(); });
      db.ref('users').on('value',snap=>{ const ul=document.getElementById('users-list'); ul.innerHTML=''; if(snap.val())Object.keys(snap.val()).forEach(u=>{ const li=document.createElement('li'); li.textContent=u; ul.appendChild(li); }); });
      db.ref('logs').orderByChild('timestamp').startAt(Date.now()-48*3600*1000).on('child_added',s=>{ const e=s.val(), t=new Date(e.timestamp).toLocaleTimeString(); const li=document.createElement('li'); li.textContent=`[${t}] ${e.text}`; document.getElementById('log-list').appendChild(li); });
    }

    function sendMessage() {
      const text=messageInput.value.trim(); if(!text) return; db.ref('messages').push({ username, type:'text', text, timestamp:Date.now() }); messageInput.value=''; }

    function sendFile() {
      const file=fileInput.files[0]; if(!file) return;
      const ref=storage.ref(`temp/${Date.now()}_${file.name}`);
      ref.put(file).then(()=>ref.getDownloadURL()).then(url=>{ db.ref('messages').push({ username, type:'image', fileUrl:url, timestamp:Date.now() }); fileInput.value=''; }).catch(console.error);
    }

    function toggleRecording() {
      if(!mediaRecorder||mediaRecorder.state==='inactive'){ navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{ mediaRecorder=new MediaRecorder(stream); mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=sendAudio; audioChunks=[]; mediaRecorder.start(); recordBtn.textContent='⏹'; }); }
      else{ mediaRecorder.stop(); recordBtn.textContent='🎤'; }
    }
    function sendAudio() { const blob=new Blob(audioChunks,{type:'audio/webm'}); const ref=storage.ref(`temp/${Date.now()}_audio.webm`);
      ref.put(blob).then(()=>ref.getDownloadURL()).then(url=>{ db.ref('messages').push({ username,type:'audio',fileUrl:url,timestamp:Date.now() }); }).catch(console.error);
    }

    function displayMessage(key,m){ if(!m||!m.timestamp) return; const c=document.createElement('div'); c.className='message '+(m.username===username?'self':''); const ts=new Date(m.timestamp).toLocaleTimeString(); c.innerHTML=`<strong>${m.username}</strong><div class="time">${ts}</div>`;
      if(m.type==='text') c.innerHTML+=`<div>${m.text}</div>`;
      if(m.type==='image'){ const img=document.createElement('img'); img.src=m.fileUrl; img.className='chat-img'; img.onclick=()=>openModal(m.fileUrl,img); c.appendChild(img); }
      if(m.type==='audio'){ const a=document.createElement('audio'); a.src=m.fileUrl; a.controls=true; c.appendChild(a); }
      document.getElementById('main-chat').appendChild(c);
    }

    function scrollBottom(){ const m=document.getElementById('main-chat'); m.scrollTop=m.scrollHeight; }
    function openModal(url,el){ const modal=document.getElementById('imgModal'); document.getElementById('modalImg').src=url; modal.style.display='flex'; modal.onclick=()=>{ modal.style.display='none'; el.remove(); }; }
    function closeModal(){ document.getElementById('imgModal').style.display='none'; }
  </script>
</body>
</html>
